# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Dream Knowledge Backend — a Jungian dream analysis platform with AI-powered extraction, agentic chat, and GraphRAG-based semantic search. Built with FastAPI, PostgreSQL, Google Gemini, and fast-graphrag.

## Commands

```bash
# Start PostgreSQL (reads DB_* vars from .env)
docker-compose up -d

# Run database migrations
alembic upgrade head

# Create a new migration
alembic revision --autogenerate -m "description"

# Rollback one migration
alembic downgrade -1

# Seed demo data (user: demo@dreamjournal.app / demo)
psql -h localhost -U $DB_USERNAME -d $DB_DATABASE -f seed_demo.sql

# Run the app (uses settings from .env for host/port/debug)
python main.py

# Health check
curl http://localhost:8000/health

# API docs (auto-generated by FastAPI)
# http://localhost:8000/docs
```

No test suite or linter is currently configured.

## Architecture

### Layered Structure

```
Controllers (FastAPI routers)  →  app/controllers/
Services (business logic)      →  app/services/
Repositories (DB queries)      →  app/repositories/
Models (SQLAlchemy ORM)        →  app/models/
```

**Data model types are split across two directories:**
- `app/data_models/` — Pydantic models for API request/response (external-facing)
- `app/schemas/` — Internal data structures (tool results, agent data, extraction schemas, indexing formats)

### Database

- PostgreSQL 15 via Docker, async driver (`asyncpg` + SQLAlchemy async)
- `app/database.py` — engine, session factory, `get_db()` dependency (auto-commits on success, rolls back on exception)
- Alembic for migrations; DB URL built from individual `DB_*` env vars (not a single connection string)
- All ORM models inherit from `Base` in `app/database.py`

### Authentication

JWT-based. `app/dependencies/auth.py` provides `get_current_user_id` dependency for protected routes. Tokens expire in 7 days. Algorithm: HS256 with `SECRET_KEY`.

### LLM Agent System

The dream analysis agent (`app/services/dream_agent.py`) uses the Google Gemini API directly (via `google.genai`), not the OpenAI SDK.

**Flow:** User message → `DreamAgent.chat()` → Gemini with tool definitions → tool execution loop (max 5 rounds) → final response with sources.

Key pieces:
- **Tool definitions**: `app/llm/tools/` — 18 tools defined as `BaseTool` dataclasses with JSON schemas, organized by domain (symbol, character, emotion, theme, dream, general)
- **Tool registry**: `app/llm/tools/tool_registry.py` — `TOOL_DEFINITIONS` list consumed by agent
- **Tool execution**: `app/services/agent_tools.py` — `AgentTools` class maps tool names to methods, delegates to `AgentRepository` for DB queries and `GraphRAGService` for semantic search
- **Prompts**: `app/prompts/system_prompt.md` (agent persona), `extraction_prompt.md` (structured extraction), `dream_domain.md` (GraphRAG domain config)
- **Agent caching**: instances cached per user/chat to preserve conversation history (last 20 messages)

### Extraction Pipeline

`app/services/extraction_service.py` sends dream narratives to Gemini for structured JSON extraction of symbols, characters, themes, emotions, setting analysis, and Jungian interpretation. Uses instructor-style structured output.

### GraphRAG

`app/services/graphrag_service.py` wraps `fast-graphrag` for per-user knowledge graphs stored in `data/graphs/{user_id}/`. Uses Gemini embeddings (`text-embedding-004`, 768-dim). `app/services/indexing_service.py` formats dreams into structured text for indexing.

## Configuration

All settings via `app/config.py` (Pydantic `BaseSettings`, loads from `.env`). Key vars:
- `GEMINI_API_KEY` — primary LLM key
- `SECRET_KEY` — JWT signing
- `DB_HOST`, `DB_PORT`, `DB_DATABASE`, `DB_USERNAME`, `DB_PASSWORD`
- `AGENT_MODEL` / `LLM_MODEL` — default `gemini-3-flash-preview`
- `GRAPH_STORAGE_PATH` — default `./data/graphs`

## Key Enums

Defined in `app/models/enums/dream_enums.py`:
- `LucidityLevel`: none, brief_awareness, partial, full
- `CharacterType`: known_person, unknown_person, self, animal, mythical, abstract
- `RoleInDream`: protagonist, antagonist, helper, observer, transformer
- `Archetype`: shadow, anima, animus, wise_old_man, wise_old_woman, trickster, hero, mother, father, child, self, persona
- `SymbolCategory`: object, place, action, animal, nature, body, other

## API Route Prefixes

| Router | Prefix | Auth |
|--------|--------|------|
| auth_router | `/auth` | No |
| dream_router | `/dreams` | Yes |
| symbol_router | `/symbols` | Yes |
| character_router | `/characters` | Yes |
| chat_router | `/chat` | Yes |
| graph_router | `/graph` | Yes |
| analytics_router | `/analytics` | Yes |
| extraction_router | `/extract` | Yes |
| demo_router | `/demo` | No |
